
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A simple async ORM with fastapi in mind and pydantic validation.">
      
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>prefetch_query - ormar</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-72514911-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");ga("send","event","feedback","click",t,e),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){ga("send","pageview",e.pathname)})});var e=document.createElement("script");e.async=!0,e.src="https://www.google-analytics.com/analytics.js",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ormar.queryset.queries.prefetch_query" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="ormar" class="md-header__button md-logo" aria-label="ormar" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ormar
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              prefetch_query
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/collerek/ormar" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    collerek/ormar
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="ormar" class="md-nav__button md-logo" aria-label="ormar" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    ormar
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/collerek/ormar" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    collerek/ormar
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Models
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Models" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../models/" class="md-nav__link">
        Definition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../models/inheritance/" class="md-nav__link">
        Inheritance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../models/methods/" class="md-nav__link">
        Methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../models/migrations/" class="md-nav__link">
        Migrations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../models/internals/" class="md-nav__link">
        Internals
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Fields
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Fields" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Fields
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fields/common-parameters/" class="md-nav__link">
        Common parameters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fields/field-types/" class="md-nav__link">
        Fields types
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fields/pydantic-fields/" class="md-nav__link">
        Pydantic only fields
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fields/encryption/" class="md-nav__link">
        Fields encryption
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../relations/">Relations</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Relations" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Relations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../relations/postponed-annotations/" class="md-nav__link">
        Postponed annotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../relations/foreign-key/" class="md-nav__link">
        ForeignKey
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../relations/many-to-many/" class="md-nav__link">
        ManyToMany
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../relations/queryset-proxy/" class="md-nav__link">
        QuerySetProxy
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../queries/">Queries</a>
          
            <label for="__nav_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Queries" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Queries
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/create/" class="md-nav__link">
        Insert data into database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/read/" class="md-nav__link">
        Read data from database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/update/" class="md-nav__link">
        Update data in database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/delete/" class="md-nav__link">
        Delete data from database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/joins-and-subqueries/" class="md-nav__link">
        Joins and subqueries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/filter-and-sort/" class="md-nav__link">
        Filtering and sorting data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/select-columns/" class="md-nav__link">
        Selecting subset of columns
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/pagination-and-rows-number/" class="md-nav__link">
        Pagination and rows number
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/aggregations/" class="md-nav__link">
        Aggregation functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../queries/raw-data/" class="md-nav__link">
        Return raw data
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../signals/" class="md-nav__link">
        Signals
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../transactions/" class="md-nav__link">
        Transactions
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          Use with Fastapi
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Use with Fastapi" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Use with Fastapi
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fastapi/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fastapi/response/" class="md-nav__link">
        Using ormar in responses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fastapi/requests/" class="md-nav__link">
        Using ormar in requests
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../mypy/" class="md-nav__link">
        Use with mypy
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../plugin/" class="md-nav__link">
        PyCharm plugin
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../releases/" class="md-nav__link">
        Release Notes
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14" type="checkbox" id="__nav_14" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_14">
          Api (BETA)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Api (BETA)" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Api (BETA)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1" type="checkbox" id="__nav_14_1" checked>
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../">ormar</a>
          
            <label for="__nav_14_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="ormar" data-md-level="2">
        <label class="md-nav__title" for="__nav_14_1">
          <span class="md-nav__icon md-icon"></span>
          ormar
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_1" type="checkbox" id="__nav_14_1_1" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../decorators/">decorators</a>
          
            <label for="__nav_14_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="decorators" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_1">
          <span class="md-nav__icon md-icon"></span>
          decorators
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../decorators/property_field/" class="md-nav__link">
        property_field
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../decorators/signals/" class="md-nav__link">
        signals
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exceptions/" class="md-nav__link">
        exceptions
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_3" type="checkbox" id="__nav_14_1_3" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../fields/">fields</a>
          
            <label for="__nav_14_1_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="fields" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_3">
          <span class="md-nav__icon md-icon"></span>
          fields
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/base/" class="md-nav__link">
        base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/constraints/" class="md-nav__link">
        constraints
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/foreign_key/" class="md-nav__link">
        foreign_key
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/many_to_many/" class="md-nav__link">
        many_to_many
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/model_fields/" class="md-nav__link">
        model_fields
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/parsers/" class="md-nav__link">
        parsers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/referential_actions/" class="md-nav__link">
        referential_actions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/sqlalchemy_encrypted/" class="md-nav__link">
        sqlalchemy_encrypted
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/sqlalchemy_uuid/" class="md-nav__link">
        sqlalchemy_uuid
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fields/through_field/" class="md-nav__link">
        through_field
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_4" type="checkbox" id="__nav_14_1_4" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../models/">models</a>
          
            <label for="__nav_14_1_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="models" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_4">
          <span class="md-nav__icon md-icon"></span>
          models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_4_1" type="checkbox" id="__nav_14_1_4_1" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../models/descriptors/">descriptors</a>
          
            <label for="__nav_14_1_4_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="descriptors" data-md-level="4">
        <label class="md-nav__title" for="__nav_14_1_4_1">
          <span class="md-nav__icon md-icon"></span>
          descriptors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/descriptors/descriptors/" class="md-nav__link">
        descriptors
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/excludable/" class="md-nav__link">
        excludable
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_4_3" type="checkbox" id="__nav_14_1_4_3" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../models/helpers/">helpers</a>
          
            <label for="__nav_14_1_4_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="helpers" data-md-level="4">
        <label class="md-nav__title" for="__nav_14_1_4_3">
          <span class="md-nav__icon md-icon"></span>
          helpers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/helpers/models/" class="md-nav__link">
        models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/helpers/pydantic/" class="md-nav__link">
        pydantic
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/helpers/related_names_validation/" class="md-nav__link">
        related_names_validation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/helpers/relations/" class="md-nav__link">
        relations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/helpers/sqlalchemy/" class="md-nav__link">
        sqlalchemy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/helpers/validation/" class="md-nav__link">
        validation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/metaclass/" class="md-nav__link">
        metaclass
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_4_5" type="checkbox" id="__nav_14_1_4_5" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../models/mixins/">mixins</a>
          
            <label for="__nav_14_1_4_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="mixins" data-md-level="4">
        <label class="md-nav__title" for="__nav_14_1_4_5">
          <span class="md-nav__icon md-icon"></span>
          mixins
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/mixins/alias_mixin/" class="md-nav__link">
        alias_mixin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/mixins/excludable_mixin/" class="md-nav__link">
        excludable_mixin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/mixins/merge_mixin/" class="md-nav__link">
        merge_mixin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/mixins/prefetch_mixin/" class="md-nav__link">
        prefetch_mixin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/mixins/pydantic_mixin/" class="md-nav__link">
        pydantic_mixin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/mixins/relation_mixin/" class="md-nav__link">
        relation_mixin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/mixins/save_mixin/" class="md-nav__link">
        save_mixin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/model/" class="md-nav__link">
        model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/model_row/" class="md-nav__link">
        model_row
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/modelproxy/" class="md-nav__link">
        modelproxy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/newbasemodel/" class="md-nav__link">
        newbasemodel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/quick_access_views/" class="md-nav__link">
        quick_access_views
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/traversible/" class="md-nav__link">
        traversible
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_5" type="checkbox" id="__nav_14_1_5" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../protocols/">protocols</a>
          
            <label for="__nav_14_1_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="protocols" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_5">
          <span class="md-nav__icon md-icon"></span>
          protocols
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../protocols/queryset_protocol/" class="md-nav__link">
        queryset_protocol
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../protocols/relation_protocol/" class="md-nav__link">
        relation_protocol
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_6" type="checkbox" id="__nav_14_1_6" checked>
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../">queryset</a>
          
            <label for="__nav_14_1_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="queryset" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_6">
          <span class="md-nav__icon md-icon"></span>
          queryset
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_6_1" type="checkbox" id="__nav_14_1_6_1" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../actions/">actions</a>
          
            <label for="__nav_14_1_6_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="actions" data-md-level="4">
        <label class="md-nav__title" for="__nav_14_1_6_1">
          <span class="md-nav__icon md-icon"></span>
          actions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../actions/filter_action/" class="md-nav__link">
        filter_action
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../actions/order_action/" class="md-nav__link">
        order_action
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../actions/query_action/" class="md-nav__link">
        query_action
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../actions/select_action/" class="md-nav__link">
        select_action
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../clause/" class="md-nav__link">
        clause
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../field_accessor/" class="md-nav__link">
        field_accessor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../join/" class="md-nav__link">
        join
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_6_5" type="checkbox" id="__nav_14_1_6_5" checked>
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">queries</a>
          
            <label for="__nav_14_1_6_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="queries" data-md-level="4">
        <label class="md-nav__title" for="__nav_14_1_6_5">
          <span class="md-nav__icon md-icon"></span>
          queries
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../filter_query/" class="md-nav__link">
        filter_query
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../limit_query/" class="md-nav__link">
        limit_query
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../offset_query/" class="md-nav__link">
        offset_query
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../order_query/" class="md-nav__link">
        order_query
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          prefetch_query
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        prefetch_query
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query" class="md-nav__link">
    ormar.queryset.queries.prefetch_query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query.PrefetchQuery" class="md-nav__link">
    PrefetchQuery
  </a>
  
    <nav class="md-nav" aria-label="PrefetchQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query.PrefetchQuery.prefetch_related" class="md-nav__link">
    prefetch_related()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query.set_children_on_model" class="md-nav__link">
    set_children_on_model()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query.sort_models" class="md-nav__link">
    sort_models()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../query/" class="md-nav__link">
        query
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../queryset/" class="md-nav__link">
        queryset
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reverse_alias_resolver/" class="md-nav__link">
        reverse_alias_resolver
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_7" type="checkbox" id="__nav_14_1_7" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../relations/">relations</a>
          
            <label for="__nav_14_1_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="relations" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_7">
          <span class="md-nav__icon md-icon"></span>
          relations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../relations/alias_manager/" class="md-nav__link">
        alias_manager
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../relations/querysetproxy/" class="md-nav__link">
        querysetproxy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../relations/relation/" class="md-nav__link">
        relation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../relations/relation_manager/" class="md-nav__link">
        relation_manager
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../relations/relation_proxy/" class="md-nav__link">
        relation_proxy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../relations/utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14_1_8" type="checkbox" id="__nav_14_1_8" >
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../signals/">signals</a>
          
            <label for="__nav_14_1_8">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="signals" data-md-level="3">
        <label class="md-nav__title" for="__nav_14_1_8">
          <span class="md-nav__icon md-icon"></span>
          signals
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../signals/signal/" class="md-nav__link">
        signal
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query" class="md-nav__link">
    ormar.queryset.queries.prefetch_query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query.PrefetchQuery" class="md-nav__link">
    PrefetchQuery
  </a>
  
    <nav class="md-nav" aria-label="PrefetchQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query.PrefetchQuery.prefetch_related" class="md-nav__link">
    prefetch_related()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query.set_children_on_model" class="md-nav__link">
    set_children_on_model()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ormar.queryset.queries.prefetch_query.sort_models" class="md-nav__link">
    sort_models()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/collerek/ormar/edit/master/docs/ormar/queryset/queries/prefetch_query.py" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>prefetch_query</h1>

<div class="doc doc-object doc-module">


<a id="ormar.queryset.queries.prefetch_query"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="ormar.queryset.queries.prefetch_query.PrefetchQuery" class="doc doc-heading">
        <code>PrefetchQuery</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Query used to fetch related models in subsequent queries.
Each model is fetched only ones by the name of the relation.
That means that for each prefetch_related entry next query is issued to database.</p>


        <details class="quote">
          <summary>Source code in <code>ormar/queryset/queries/prefetch_query.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PrefetchQuery</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query used to fetch related models in subsequent queries.</span>
<span class="sd">    Each model is fetched only ones by the name of the relation.</span>
<span class="sd">    That means that for each prefetch_related entry next query is issued to database.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># noqa: CFQ002</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span>
        <span class="n">excludable</span><span class="p">:</span> <span class="s2">&quot;ExcludableItems&quot;</span><span class="p">,</span>
        <span class="n">prefetch_related</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
        <span class="n">select_related</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
        <span class="n">orders_by</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;OrderAction&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_related</span> <span class="o">=</span> <span class="n">prefetch_related</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_related</span> <span class="o">=</span> <span class="n">select_related</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excludable</span> <span class="o">=</span> <span class="n">excludable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">already_extracted</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_dict</span> <span class="o">=</span> <span class="n">translate_list_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_related</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders_by</span> <span class="o">=</span> <span class="n">orders_by</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c1"># TODO: refactor OrderActions to use it instead of strings from it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_dict</span> <span class="o">=</span> <span class="n">translate_list_to_dict</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">query_str</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_by</span><span class="p">],</span> <span class="n">is_order</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">prefetch_related</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span> <span class="n">rows</span><span class="p">:</span> <span class="n">List</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main entry point for prefetch_query.</span>

<span class="sd">        Receives list of already initialized parent models with all children from</span>
<span class="sd">        select_related already populated. Receives also list of row sql result rows</span>
<span class="sd">        as it&#39;s quicker to extract ids that way instead of calling each model.</span>

<span class="sd">        Returns list with related models already prefetched and set.</span>

<span class="sd">        :param models: list of already instantiated models from main query</span>
<span class="sd">        :type models: List[Model]</span>
<span class="sd">        :param rows: row sql result of the main query before the prefetch</span>
<span class="sd">        :type rows: List[sqlalchemy.engine.result.RowProxy]</span>
<span class="sd">        :return: list of models with children prefetched</span>
<span class="sd">        :rtype: List[Model]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">extract_models_to_dict_of_lists</span><span class="p">(</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span> <span class="n">select_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">select_dict</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">models</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_related_models</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_ids_from_raw_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parent_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates over raw rows and extract id values of relation columns by using</span>
<span class="sd">        prefixed column name.</span>

<span class="sd">        :param parent_model: ormar model class</span>
<span class="sd">        :type parent_model: Type[Model]</span>
<span class="sd">        :param column_name: name of the relation column which is a key column</span>
<span class="sd">        :type column_name: str</span>
<span class="sd">        :return: set of ids of related model that should be extracted</span>
<span class="sd">        :rtype: set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_of_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">current_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_model</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="p">{})</span>
        <span class="n">table_prefix</span> <span class="o">=</span> <span class="n">current_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">column_name</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_prefix</span><span class="si">}</span><span class="s2">_&quot;</span> <span class="k">if</span> <span class="n">table_prefix</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">column_name</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">current_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">column_name</span><span class="p">]:</span>
                <span class="n">list_of_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">list_of_ids</span>

    <span class="k">def</span> <span class="nf">_extract_ids_from_preloaded_models</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parent_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts relation ids from already populated models if they were included</span>
<span class="sd">        in the original query before.</span>

<span class="sd">        :param parent_model: model from which related ids should be extracted</span>
<span class="sd">        :type parent_model: Type[&quot;Model&quot;]</span>
<span class="sd">        :param column_name: name of the relation column which is a key column</span>
<span class="sd">        :type column_name: str</span>
<span class="sd">        :return: set of ids of related model that should be extracted</span>
<span class="sd">        :rtype: set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_of_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_model</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="p">[]):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">column_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">ormar</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
                <span class="n">list_of_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">list_of_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">list_of_ids</span>

    <span class="k">def</span> <span class="nf">_extract_required_ids</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parent_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">related</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delegates extraction of the fields to either get ids from raw sql response</span>
<span class="sd">        or from already populated models.</span>

<span class="sd">        :param parent_model: model from which related ids should be extracted</span>
<span class="sd">        :type parent_model: Type[&quot;Model&quot;]</span>
<span class="sd">        :param reverse: flag if the relation is reverse</span>
<span class="sd">        :type reverse: bool</span>
<span class="sd">        :param related: name of the field with relation</span>
<span class="sd">        :type related: str</span>
<span class="sd">        :return: set of ids of related model that should be extracted</span>
<span class="sd">        :rtype: set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_raw</span> <span class="o">=</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span>

        <span class="n">column_name</span> <span class="o">=</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">get_column_name_for_id_extraction</span><span class="p">(</span>
            <span class="n">parent_model</span><span class="o">=</span><span class="n">parent_model</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span> <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="n">use_raw</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_ids_from_raw_data</span><span class="p">(</span>
                <span class="n">parent_model</span><span class="o">=</span><span class="n">parent_model</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="n">column_name</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_ids_from_preloaded_models</span><span class="p">(</span>
            <span class="n">parent_model</span><span class="o">=</span><span class="n">parent_model</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="n">column_name</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_filter_for_prefetch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parent_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span>
        <span class="n">target_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span>
        <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">related</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates where clause with condition to return only models within the</span>
<span class="sd">        set of extracted ids.</span>

<span class="sd">        If there are no ids for relation the empty list is returned.</span>

<span class="sd">        :param parent_model: model from which related ids should be extracted</span>
<span class="sd">        :type parent_model: Type[&quot;Model&quot;]</span>
<span class="sd">        :param target_model: model to which relation leads to</span>
<span class="sd">        :type target_model: Type[&quot;Model&quot;]</span>
<span class="sd">        :param reverse: flag if the relation is reverse</span>
<span class="sd">        :type reverse: bool</span>
<span class="sd">        :param related: name of the field with relation</span>
<span class="sd">        :type related: str</span>
<span class="sd">        :return:</span>
<span class="sd">        :rtype: List[sqlalchemy.sql.elements.TextClause]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_required_ids</span><span class="p">(</span>
            <span class="n">parent_model</span><span class="o">=</span><span class="n">parent_model</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span> <span class="n">related</span><span class="o">=</span><span class="n">related</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">clause_target</span><span class="p">,</span>
                <span class="n">filter_column</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">get_clause_target_and_filter_column_name</span><span class="p">(</span>
                <span class="n">parent_model</span><span class="o">=</span><span class="n">parent_model</span><span class="p">,</span>
                <span class="n">target_model</span><span class="o">=</span><span class="n">target_model</span><span class="p">,</span>
                <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
                <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">qryclause</span> <span class="o">=</span> <span class="n">QueryClause</span><span class="p">(</span>
                <span class="n">model_cls</span><span class="o">=</span><span class="n">clause_target</span><span class="p">,</span> <span class="n">select_related</span><span class="o">=</span><span class="p">[],</span> <span class="n">filter_clauses</span><span class="o">=</span><span class="p">[]</span>
            <span class="p">)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filter_column</span><span class="si">}</span><span class="s2">__in&quot;</span><span class="p">:</span> <span class="n">ids</span><span class="p">}</span>
            <span class="n">filter_clauses</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">qryclause</span><span class="o">.</span><span class="n">prepare_filter</span><span class="p">(</span><span class="n">_own_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">filter_clauses</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_populate_nested_related</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span><span class="p">,</span> <span class="n">prefetch_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">orders_by</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Model&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates all related models children of parent model that are</span>
<span class="sd">        included in prefetch query.</span>

<span class="sd">        :param model: ormar model instance</span>
<span class="sd">        :type model: Model</span>
<span class="sd">        :param prefetch_dict: dictionary of models to prefetch</span>
<span class="sd">        :type prefetch_dict: Dict</span>
<span class="sd">        :param orders_by: dictionary of order bys</span>
<span class="sd">        :type orders_by: Dict</span>
<span class="sd">        :return: model with children populated</span>
<span class="sd">        :rtype: Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">related_to_extract</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_filtered_names_to_extract</span><span class="p">(</span>
            <span class="n">prefetch_dict</span><span class="o">=</span><span class="n">prefetch_dict</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">related</span> <span class="ow">in</span> <span class="n">related_to_extract</span><span class="p">:</span>
            <span class="n">target_field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">model_fields</span><span class="p">[</span><span class="n">related</span><span class="p">]</span>
            <span class="n">target_field</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;ForeignKeyField&quot;</span><span class="p">,</span> <span class="n">target_field</span><span class="p">)</span>
            <span class="n">target_model</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_relation_model_id</span><span class="p">(</span><span class="n">target_field</span><span class="o">=</span><span class="n">target_field</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">continue</span>

            <span class="n">field_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_related_field_name</span><span class="p">(</span><span class="n">target_field</span><span class="o">=</span><span class="n">target_field</span><span class="p">)</span>

            <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_model</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_model</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pk_models&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">set_children_on_model</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span>
                <span class="n">children</span><span class="o">=</span><span class="n">children</span><span class="p">,</span>
                <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span>
                <span class="n">orders_by</span><span class="o">=</span><span class="n">orders_by</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">related</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_prefetch_related_models</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span> <span class="n">rows</span><span class="p">:</span> <span class="n">List</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main method of the query.</span>

<span class="sd">        Translates select nad prefetch list into dictionaries to avoid querying the</span>
<span class="sd">        same related models multiple times.</span>

<span class="sd">        Keeps the list of already extracted models.</span>

<span class="sd">        Extracts the related models from the database and later populate all children</span>
<span class="sd">        on each of the parent models from list.</span>

<span class="sd">        :param models: list of parent models from main query</span>
<span class="sd">        :type models: List[Model]</span>
<span class="sd">        :param rows: raw response from sql query</span>
<span class="sd">        :type rows: List[sqlalchemy.engine.result.RowProxy]</span>
<span class="sd">        :return: list of models with prefetch children populated</span>
<span class="sd">        :rtype: List[Model]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">already_extracted</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_name</span><span class="p">():</span> <span class="p">{</span><span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">rows</span><span class="p">}}</span>
        <span class="n">select_dict</span> <span class="o">=</span> <span class="n">translate_list_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_related</span><span class="p">)</span>
        <span class="n">prefetch_dict</span> <span class="o">=</span> <span class="n">translate_list_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_related</span><span class="p">)</span>
        <span class="n">target_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">orders_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_dict</span>
        <span class="k">for</span> <span class="n">related</span> <span class="ow">in</span> <span class="n">prefetch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_related_models</span><span class="p">(</span>
                <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span>
                <span class="n">target_model</span><span class="o">=</span><span class="n">target_model</span><span class="p">,</span>
                <span class="n">prefetch_dict</span><span class="o">=</span><span class="n">prefetch_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">related</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="n">select_dict</span><span class="o">=</span><span class="n">select_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">related</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="n">excludable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">excludable</span><span class="p">,</span>
                <span class="n">orders_by</span><span class="o">=</span><span class="n">orders_by</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">related</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">)</span>
        <span class="n">final_models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="n">final_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_populate_nested_related</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">prefetch_dict</span><span class="o">=</span><span class="n">prefetch_dict</span><span class="p">,</span> <span class="n">orders_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order_dict</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">models</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_extract_related_models</span><span class="p">(</span>  <span class="c1"># noqa: CFQ002, CCR001</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">related</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span>
        <span class="n">prefetch_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">select_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">excludable</span><span class="p">:</span> <span class="s2">&quot;ExcludableItems&quot;</span><span class="p">,</span>
        <span class="n">orders_by</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs queries with required ids and extracts data with fields that should</span>
<span class="sd">        be included/excluded.</span>

<span class="sd">        Runs the queries against the database and populated dictionaries with ids and</span>
<span class="sd">        with actual extracted children models.</span>

<span class="sd">        Calls itself recurrently to extract deeper nested relations of related model.</span>

<span class="sd">        :param related: name of the relation</span>
<span class="sd">        :type related: str</span>
<span class="sd">        :param target_model: model to which relation leads to</span>
<span class="sd">        :type target_model: Type[Model]</span>
<span class="sd">        :param prefetch_dict: prefetch related list converted into dictionary</span>
<span class="sd">        :type prefetch_dict: Dict</span>
<span class="sd">        :param select_dict: select related list converted into dictionary</span>
<span class="sd">        :type select_dict: Dict</span>
<span class="sd">        :param fields: fields to include</span>
<span class="sd">        :type fields: Union[Set[Any], Dict[Any, Any], None]</span>
<span class="sd">        :param exclude_fields: fields to exclude</span>
<span class="sd">        :type exclude_fields: Union[Set[Any], Dict[Any, Any], None]</span>
<span class="sd">        :param orders_by: dictionary of order bys clauses</span>
<span class="sd">        :type orders_by: Dict</span>
<span class="sd">        :return: None</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_field</span> <span class="o">=</span> <span class="n">target_model</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">model_fields</span><span class="p">[</span><span class="n">related</span><span class="p">]</span>
        <span class="n">target_field</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;ForeignKeyField&quot;</span><span class="p">,</span> <span class="n">target_field</span><span class="p">)</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">target_field</span><span class="o">.</span><span class="n">virtual</span> <span class="ow">or</span> <span class="n">target_field</span><span class="o">.</span><span class="n">is_multi</span><span class="p">:</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">parent_model</span> <span class="o">=</span> <span class="n">target_model</span>

        <span class="n">filter_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filter_for_prefetch</span><span class="p">(</span>
            <span class="n">parent_model</span><span class="o">=</span><span class="n">parent_model</span><span class="p">,</span>
            <span class="n">target_model</span><span class="o">=</span><span class="n">target_field</span><span class="o">.</span><span class="n">to</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
            <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_clauses</span><span class="p">:</span>  <span class="c1"># related field is empty</span>
            <span class="k">return</span>

        <span class="n">already_loaded</span> <span class="o">=</span> <span class="n">select_dict</span> <span class="ow">is</span> <span class="bp">Ellipsis</span> <span class="ow">or</span> <span class="n">related</span> <span class="ow">in</span> <span class="n">select_dict</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">already_loaded</span><span class="p">:</span>
            <span class="c1"># If not already loaded with select_related</span>
            <span class="n">related_field_name</span> <span class="o">=</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">get_related_field_name</span><span class="p">(</span>
                <span class="n">target_field</span><span class="o">=</span><span class="n">target_field</span>
            <span class="p">)</span>
            <span class="n">table_prefix</span><span class="p">,</span> <span class="n">exclude_prefix</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_prefetch_query</span><span class="p">(</span>
                <span class="n">target_field</span><span class="o">=</span><span class="n">target_field</span><span class="p">,</span>
                <span class="n">excludable</span><span class="o">=</span><span class="n">excludable</span><span class="p">,</span>
                <span class="n">filter_clauses</span><span class="o">=</span><span class="n">filter_clauses</span><span class="p">,</span>
                <span class="n">related_field_name</span><span class="o">=</span><span class="n">related_field_name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">table_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">exclude_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">prefetch_dict</span> <span class="ow">and</span> <span class="n">prefetch_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">Ellipsis</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subrelated</span> <span class="ow">in</span> <span class="n">prefetch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_related_models</span><span class="p">(</span>
                    <span class="n">related</span><span class="o">=</span><span class="n">subrelated</span><span class="p">,</span>
                    <span class="n">target_model</span><span class="o">=</span><span class="n">target_field</span><span class="o">.</span><span class="n">to</span><span class="p">,</span>
                    <span class="n">prefetch_dict</span><span class="o">=</span><span class="n">prefetch_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subrelated</span><span class="p">,</span> <span class="p">{}),</span>
                    <span class="n">select_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_select_related_if_apply</span><span class="p">(</span>
                        <span class="n">subrelated</span><span class="p">,</span> <span class="n">select_dict</span>
                    <span class="p">),</span>
                    <span class="n">excludable</span><span class="o">=</span><span class="n">excludable</span><span class="p">,</span>
                    <span class="n">orders_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_select_related_if_apply</span><span class="p">(</span><span class="n">subrelated</span><span class="p">,</span> <span class="n">orders_by</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">already_loaded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_populate_rows</span><span class="p">(</span>
                <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                <span class="n">parent_model</span><span class="o">=</span><span class="n">parent_model</span><span class="p">,</span>
                <span class="n">target_field</span><span class="o">=</span><span class="n">target_field</span><span class="p">,</span>
                <span class="n">table_prefix</span><span class="o">=</span><span class="n">table_prefix</span><span class="p">,</span>
                <span class="n">exclude_prefix</span><span class="o">=</span><span class="n">exclude_prefix</span><span class="p">,</span>
                <span class="n">excludable</span><span class="o">=</span><span class="n">excludable</span><span class="p">,</span>
                <span class="n">prefetch_dict</span><span class="o">=</span><span class="n">prefetch_dict</span><span class="p">,</span>
                <span class="n">orders_by</span><span class="o">=</span><span class="n">orders_by</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_already_loaded_rows</span><span class="p">(</span>
                <span class="n">target_field</span><span class="o">=</span><span class="n">target_field</span><span class="p">,</span>
                <span class="n">prefetch_dict</span><span class="o">=</span><span class="n">prefetch_dict</span><span class="p">,</span>
                <span class="n">orders_by</span><span class="o">=</span><span class="n">orders_by</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_run_prefetch_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target_field</span><span class="p">:</span> <span class="s2">&quot;BaseField&quot;</span><span class="p">,</span>
        <span class="n">excludable</span><span class="p">:</span> <span class="s2">&quot;ExcludableItems&quot;</span><span class="p">,</span>
        <span class="n">filter_clauses</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
        <span class="n">related_field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actually runs the queries against the database and populates the raw response</span>
<span class="sd">        for given related model.</span>

<span class="sd">        Returns table prefix as it&#39;s later needed to eventually initialize the children</span>
<span class="sd">        models.</span>

<span class="sd">        :param target_field: ormar field with relation definition</span>
<span class="sd">        :type target_field: &quot;BaseField&quot;</span>
<span class="sd">        :param filter_clauses: list of clauses, actually one clause with ids of relation</span>
<span class="sd">        :type filter_clauses: List[sqlalchemy.sql.elements.TextClause]</span>
<span class="sd">        :return: table prefix and raw rows from sql response</span>
<span class="sd">        :rtype: Tuple[str, List]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_model</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">to</span>
        <span class="n">target_name</span> <span class="o">=</span> <span class="n">target_model</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
        <span class="n">select_related</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">query_target</span> <span class="o">=</span> <span class="n">target_model</span>
        <span class="n">table_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">exclude_prefix</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">alias_manager</span><span class="o">.</span><span class="n">resolve_relation_alias</span><span class="p">(</span>
            <span class="n">from_model</span><span class="o">=</span><span class="n">target_field</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">relation_name</span><span class="o">=</span><span class="n">target_field</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">target_field</span><span class="o">.</span><span class="n">is_multi</span><span class="p">:</span>
            <span class="n">query_target</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">through</span>
            <span class="n">select_related</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_name</span><span class="p">]</span>
            <span class="n">table_prefix</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">alias_manager</span><span class="o">.</span><span class="n">resolve_relation_alias</span><span class="p">(</span>
                <span class="n">from_model</span><span class="o">=</span><span class="n">query_target</span><span class="p">,</span> <span class="n">relation_name</span><span class="o">=</span><span class="n">target_name</span>
            <span class="p">)</span>
            <span class="n">exclude_prefix</span> <span class="o">=</span> <span class="n">table_prefix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">already_extracted</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="p">{})[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_prefix</span>

        <span class="n">model_excludable</span> <span class="o">=</span> <span class="n">excludable</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_cls</span><span class="o">=</span><span class="n">target_model</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">exclude_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_excludable</span><span class="o">.</span><span class="n">include</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">model_excludable</span><span class="o">.</span><span class="n">is_included</span><span class="p">(</span>
            <span class="n">related_field_name</span>
        <span class="p">):</span>
            <span class="n">model_excludable</span><span class="o">.</span><span class="n">set_values</span><span class="p">({</span><span class="n">related_field_name</span><span class="p">},</span> <span class="n">is_exclude</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">qry</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
            <span class="n">model_cls</span><span class="o">=</span><span class="n">query_target</span><span class="p">,</span>
            <span class="n">select_related</span><span class="o">=</span><span class="n">select_related</span><span class="p">,</span>
            <span class="n">filter_clauses</span><span class="o">=</span><span class="n">filter_clauses</span><span class="p">,</span>
            <span class="n">exclude_clauses</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">limit_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">excludable</span><span class="o">=</span><span class="n">excludable</span><span class="p">,</span>
            <span class="n">order_bys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">limit_raw_sql</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">qry</span><span class="o">.</span><span class="n">build_select_expression</span><span class="p">()</span>
        <span class="c1"># print(expr.compile(compile_kwargs={&quot;literal_binds&quot;: True}))</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">already_extracted</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">rows</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">table_prefix</span><span class="p">,</span> <span class="n">exclude_prefix</span><span class="p">,</span> <span class="n">rows</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_select_related_if_apply</span><span class="p">(</span><span class="n">related</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">select_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract nested related of select_related dictionary to extract models nested</span>
<span class="sd">        deeper on related model and already loaded in select related query.</span>

<span class="sd">        :param related: name of the relation</span>
<span class="sd">        :type related: str</span>
<span class="sd">        :param select_dict: dictionary of select related models in main query</span>
<span class="sd">        :type select_dict: Dict</span>
<span class="sd">        :return: dictionary with nested related of select related</span>
<span class="sd">        :rtype: Dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">select_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">related</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">select_dict</span> <span class="ow">and</span> <span class="n">select_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">Ellipsis</span> <span class="ow">and</span> <span class="n">related</span> <span class="ow">in</span> <span class="n">select_dict</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">{}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_already_loaded_rows</span><span class="p">(</span>  <span class="c1"># noqa: CFQ002</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">target_field</span><span class="p">:</span> <span class="s2">&quot;BaseField&quot;</span><span class="p">,</span> <span class="n">prefetch_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">orders_by</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates models that are already loaded, usually children of children.</span>

<span class="sd">        :param target_field: ormar field with relation definition</span>
<span class="sd">        :type target_field: &quot;BaseField&quot;</span>
<span class="sd">        :param prefetch_dict: dictionaries of related models to prefetch</span>
<span class="sd">        :type prefetch_dict: Dict</span>
<span class="sd">        :param orders_by: dictionary of order by clauses by model</span>
<span class="sd">        :type orders_by: Dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_model</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">to</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_model</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="p">[]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_populate_nested_related</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">prefetch_dict</span><span class="o">=</span><span class="n">prefetch_dict</span><span class="p">,</span> <span class="n">orders_by</span><span class="o">=</span><span class="n">orders_by</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_populate_rows</span><span class="p">(</span>  <span class="c1"># noqa: CFQ002</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rows</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
        <span class="n">target_field</span><span class="p">:</span> <span class="s2">&quot;ForeignKeyField&quot;</span><span class="p">,</span>
        <span class="n">parent_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span>
        <span class="n">table_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">exclude_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">excludable</span><span class="p">:</span> <span class="s2">&quot;ExcludableItems&quot;</span><span class="p">,</span>
        <span class="n">prefetch_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">orders_by</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiates children models extracted from given relation.</span>

<span class="sd">        Populates them with their own nested children if they are included in prefetch</span>
<span class="sd">        query.</span>

<span class="sd">        Sets the initialized models and ids of them under corresponding keys in</span>
<span class="sd">        already_extracted dictionary. Later those instances will be fetched by ids</span>
<span class="sd">        and set on the parent model after sorting if needed.</span>

<span class="sd">        :param excludable: structure of fields to include and exclude</span>
<span class="sd">        :type excludable: ExcludableItems</span>
<span class="sd">        :param rows: raw sql response from the prefetch query</span>
<span class="sd">        :type rows: List[sqlalchemy.engine.result.RowProxy]</span>
<span class="sd">        :param target_field: field with relation definition from parent model</span>
<span class="sd">        :type target_field: &quot;BaseField&quot;</span>
<span class="sd">        :param parent_model: model with relation definition</span>
<span class="sd">        :type parent_model: Type[Model]</span>
<span class="sd">        :param table_prefix: prefix of the target table from current relation</span>
<span class="sd">        :type table_prefix: str</span>
<span class="sd">        :param prefetch_dict: dictionaries of related models to prefetch</span>
<span class="sd">        :type prefetch_dict: Dict</span>
<span class="sd">        :param orders_by: dictionary of order by clauses by model</span>
<span class="sd">        :type orders_by: Dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_model</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">to</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">get_related_field_name</span><span class="p">(</span><span class="n">target_field</span><span class="o">=</span><span class="n">target_field</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">target_model</span><span class="o">.</span><span class="n">extract_prefixed_table_columns</span><span class="p">(</span>
                <span class="n">item</span><span class="o">=</span><span class="p">{},</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">table_prefix</span><span class="o">=</span><span class="n">table_prefix</span><span class="p">,</span> <span class="n">excludable</span><span class="o">=</span><span class="n">excludable</span>
            <span class="p">)</span>
            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;__excluded__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_model</span><span class="o">.</span><span class="n">get_names_to_exclude</span><span class="p">(</span>
                <span class="n">excludable</span><span class="o">=</span><span class="n">excludable</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">exclude_prefix</span>
            <span class="p">)</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">target_model</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate_nested_related</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">prefetch_dict</span><span class="o">=</span><span class="n">prefetch_dict</span><span class="p">,</span> <span class="n">orders_by</span><span class="o">=</span><span class="n">orders_by</span>
            <span class="p">)</span>
            <span class="n">field_db_name</span> <span class="o">=</span> <span class="n">target_model</span><span class="o">.</span><span class="n">get_column_alias</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_extracted</span><span class="p">[</span><span class="n">target_model</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="s2">&quot;pk_models&quot;</span><span class="p">,</span> <span class="p">{}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">pk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                <span class="n">models</span><span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">already_extracted</span><span class="p">[</span><span class="n">target_model</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="n">field_name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">field_db_name</span><span class="p">],</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="ormar.queryset.queries.prefetch_query.PrefetchQuery.prefetch_related" class="doc doc-heading">
<code class="highlight language-python"><span class="n">prefetch_related</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Main entry point for prefetch_query.</p>
<p>Receives list of already initialized parent models with all children from
select_related already populated. Receives also list of row sql result rows
as it's quicker to extract ids that way instead of calling each model.</p>
<p>Returns list with related models already prefetched and set.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>models</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="ormar.Model" href="../../../#ormar.Model">Model</a>]</code>
          </td>
          <td><p>list of already instantiated models from main query</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rows</code></td>
          <td>
                <code><span title="typing.List">List</span></code>
          </td>
          <td><p>row sql result of the main query before the prefetch</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[Model]</code>
          </td>
          <td><p>list of models with children prefetched</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>ormar/queryset/queries/prefetch_query.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">prefetch_related</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span> <span class="n">rows</span><span class="p">:</span> <span class="n">List</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point for prefetch_query.</span>

<span class="sd">    Receives list of already initialized parent models with all children from</span>
<span class="sd">    select_related already populated. Receives also list of row sql result rows</span>
<span class="sd">    as it&#39;s quicker to extract ids that way instead of calling each model.</span>

<span class="sd">    Returns list with related models already prefetched and set.</span>

<span class="sd">    :param models: list of already instantiated models from main query</span>
<span class="sd">    :type models: List[Model]</span>
<span class="sd">    :param rows: row sql result of the main query before the prefetch</span>
<span class="sd">    :type rows: List[sqlalchemy.engine.result.RowProxy]</span>
<span class="sd">    :return: list of models with children prefetched</span>
<span class="sd">    :rtype: List[Model]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">extract_models_to_dict_of_lists</span><span class="p">(</span>
        <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span> <span class="n">select_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">select_dict</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">models</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_related_models</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="ormar.queryset.queries.prefetch_query.set_children_on_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_children_on_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">related</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">orders_by</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Extract ids of child models by given relation id key value.</p>
<p>Based on those ids the actual children model instances are fetched from
already fetched data.</p>
<p>If needed the child models are resorted according to passed orders_by dict.</p>
<p>Also relation is registered as each child is set as parent related field name value.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="ormar.Model" href="../../../#ormar.Model">Model</a></code>
          </td>
          <td><p>parent model instance</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>related</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>name of the related field</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>children</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span></code>
          </td>
          <td><p>dictionary of children ids/ related field value</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_id</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>id of the model on which children should be set</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>models</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span></code>
          </td>
          <td><p>dictionary of child models instances</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>orders_by</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span></code>
          </td>
          <td><p>order_by dictionary</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>ormar/queryset/queries/prefetch_query.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_children_on_model</span><span class="p">(</span>  <span class="c1"># noqa: CCR001</span>
    <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span><span class="p">,</span>
    <span class="n">related</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">children</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">model_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">orders_by</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract ids of child models by given relation id key value.</span>

<span class="sd">    Based on those ids the actual children model instances are fetched from</span>
<span class="sd">    already fetched data.</span>

<span class="sd">    If needed the child models are resorted according to passed orders_by dict.</span>

<span class="sd">    Also relation is registered as each child is set as parent related field name value.</span>

<span class="sd">    :param model: parent model instance</span>
<span class="sd">    :type model: Model</span>
<span class="sd">    :param related: name of the related field</span>
<span class="sd">    :type related: str</span>
<span class="sd">    :param children: dictionary of children ids/ related field value</span>
<span class="sd">    :type children: Dict[int, set]</span>
<span class="sd">    :param model_id: id of the model on which children should be set</span>
<span class="sd">    :type model_id: int</span>
<span class="sd">    :param models: dictionary of child models instances</span>
<span class="sd">    :type models: Dict</span>
<span class="sd">    :param orders_by: order_by dictionary</span>
<span class="sd">    :type orders_by: Dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">child_models</span> <span class="ow">in</span> <span class="n">children</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">model_id</span><span class="p">:</span>
            <span class="n">models_to_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">child_models</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">models_to_set</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">orders_by</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">orders_by</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="n">models_to_set</span> <span class="o">=</span> <span class="n">sort_models</span><span class="p">(</span>
                        <span class="n">models</span><span class="o">=</span><span class="n">models_to_set</span><span class="p">,</span> <span class="n">orders_by</span><span class="o">=</span><span class="n">orders_by</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">models_to_set</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">related</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="ormar.queryset.queries.prefetch_query.sort_models" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sort_models</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">orders_by</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Since prefetch query gets all related models by ids the sorting needs to happen in
python. Since by default models are already sorted by id here we resort only if
order_by parameters was set.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>models</code></td>
          <td>
                <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="ormar.Model" href="../../../#ormar.Model">Model</a>]</code>
          </td>
          <td><p>list of models already fetched from db</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>orders_by</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span></code>
          </td>
          <td><p>order by dictionary</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[tests.test_prefetch_related.Division]</code>
          </td>
          <td><p>sorted list of models</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>ormar/queryset/queries/prefetch_query.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sort_models</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span> <span class="n">orders_by</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Since prefetch query gets all related models by ids the sorting needs to happen in</span>
<span class="sd">    python. Since by default models are already sorted by id here we resort only if</span>
<span class="sd">    order_by parameters was set.</span>

<span class="sd">    :param models: list of models already fetched from db</span>
<span class="sd">    :type models: List[tests.test_prefetch_related.Division]</span>
<span class="sd">    :param orders_by: order by dictionary</span>
<span class="sd">    :type orders_by: Dict[str, str]</span>
<span class="sd">    :return: sorted list of models</span>
<span class="sd">    :rtype: List[tests.test_prefetch_related.Division]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sort_criteria</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orders_by</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">sort_criteria</span> <span class="o">=</span> <span class="n">sort_criteria</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">sort_criteria</span><span class="p">:</span>
        <span class="n">key_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">criteria</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;desc&quot;</span><span class="p">:</span>
            <span class="n">models</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">key_name</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">models</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">key_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">models</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../order_query/" class="md-footer__link md-footer__link--prev" aria-label="Previous: order_query" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              order_query
            </div>
          </div>
        </a>
      
      
        
        <a href="../query/" class="md-footer__link md-footer__link--next" aria-label="Next: query" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              query
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
      
        <script src="../../../../javascripts/config.js"></script>
      
    
    
  </body>
</html>